{% extends 'base.html' %}
<!---->
{% block title %} | Cart{% endblock title %}
<!---->
{% block content %}
<div class="container">
  <main>
    <div class="py-5 text-center">
      <h2>Checkout</h2>
    </div>
    <div class="row g-5">
      <div class="col-md-5 col-lg-4 order-md-last">
        <h4 class="d-flex justify-content-between align-items-center mb-3">
          <span class="text-primary">Your cart</span>
          <span class="badge bg-primary rounded-pill">{{count}}</span>
        </h4>
        <ul class="list-group mb-3">
          {% if games %}
          <!-- -->
          {% for game in games %}
          <li class="list-group-item d-flex justify-content-between lh-sm">
            <div>
              <h6 class="my-0">{{game.name}}</h6>
            </div>
            <span class="text-muted">${{game.price}}</span>
          </li>
          {% endfor %}
          <!--  -->
          {% endif %}
          <li class="list-group-item d-flex justify-content-between">
            <span>Total (USD)</span>
            <strong>${{total}}</strong>
          </li>
        </ul>
      </div>
      <div class="col-md-7 col-lg-8">
        <script src="https://www.paypal.com/sdk/js?client-id={{key}}&currency=USD"></script>
        <!-- Set up a container element for the button -->
        {% csrf_token %}
        <div id="paypal-button-container"></div>
        <script>
          const csrftoken = document.querySelector(
            "[name=csrfmiddlewaretoken]"
          ).value;
          paypal
            .Buttons({
              // Sets up the transaction when a payment button is clicked
              createOrder: (data, actions) => {
                return actions.order.create({
                  purchase_units: [
                    {
                      amount: {
                        value: "{{total}}",
                      },
                    },
                  ],
                });
              },
              // Finalize the transaction after payer approval
              onApprove: (data, actions) => {
                return actions.order.capture().then(function (orderData) {
                  const transaction =
                    orderData.purchase_units[0].payments.captures[0];
                  const f = new FormData();
                  f.append("order_id", transaction["id"]);
                  fetch("/checkout/", {
                    method: "POST",
                    redirect: "follow",
                    body: f,
                    headers: { "X-CSRFToken": csrftoken },
                    mode: "same-origin",
                  })
                    .then((response) => {
                      location.href = "/checkout/thankyou/";
                    })
                    .catch((err) => {
                      location.href = "/checkout/failed/";
                    });
                });
              },
            })
            .render("#paypal-button-container");
        </script>
      </div>
    </div>
    <!--  -->
  </main>
</div>
{% endblock content %}
